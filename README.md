# JOSM-Russia-address-helper-plugin
Плагин JOSM для загрузки адресов из ЕГРН.

Плагин автоматически производит фильтрацию выделенных объектов, выбирая только полигоны с тегом [building](https://wiki.openstreetmap.org/wiki/RU:Key:building).

## Установка

1. Скопируйте файл [russia-address-helper.jar](https://github.com/De-Luxis/JOSM-Russia-address-helper-plugin/releases/latest/download/russia-address-helper.jar) в `%appdata%\JOSM\plugins` для Windows, и в `~/.local/share/JOSM/plugins` для Linux.
2. Включите плагин в `Правка - Настройки - Модули`. 

## Как пользоваться

1. Выделяем объекты, в числе которых есть здания (можно создать поисковый запрос вида "building=* AND -"addr:housenumber=* and inview" и сохранить его на панель инструментов)
2. В меню `Данные - Russia address helper`
3. После получения адресов из ЕГРН и проверки их на вменяемость глазами не забудьте почистить данные перед отправкой:
- сделайте поиск по "addr:RU:egrn"=* и удалите этот тэг у всех найденных объектов, в ОСМ он не нужен.
- сделайте поиск по fixme=* и убедитесь что не загружаете ненужных точек в ОСМ

## Сдвиг координат

Для повышения точности определения адресов можно уточнить сдвиг координат слоя ПКК:

- Привязываем слои спутниковых снимков по ГПС трекам как обычно. Обрисовываем по ним здания.
- Подключаем WMS слой границ кадастровых участков ПКК (на данный момент это возможно только с применением прокси (например nginx) из-за проблем с сертификатами на сайте Росреестра.
- Сдвигаем слой ПКК так, чтобы границы участков совпали со спутниковым снимком.
- Переходим в настройки плагина и выбираем слой ПКК в настройке "Учитывать сдвиг..."
- При запросах к ПКК координаты здания будут модифицированы, так чтобы попасть в правильные границы.
- Если в настройках указано имя слоя, не подключенного в JOSM в момент запроса к ЕГРН, то функция сдвига работать не будет, на экране отобразится предупреждение.

## Настройки дополнительных адресных точек
В настройках плагина можно включить создание дополнительных адресных точек, если таковые будут найдены для здания.
Так же будут сгенерированы адресные точки квартир, если квартира присутствует в адресе участка или здания.

В целях отладки можно включить создание точек с нераспознанными адресами. Это поможет понять, каких улиц не хватает, или попытаться вручную расшифровать адрес.
Не загружайте такие точки в ОСМ!

## Горячая клавиша

1. Добавьте кнопку на панель инструментов в  `Правка - Настройки - Панель инструментов`. 
2. Нажмите правой кнопкой по иконке плагина на панели инструментов и выберете `Свойства горячей клавиши`.

## Ограничения

1. Не выделяйте много домов, так как с каждым домом отправляется запрос. Сервис может не выдержать или заблокировать доступ из-за большого количества запросов. В идеале работать выделяя дома вдоль улицы, приводить данные в порядок и уже после этого приступать к следующим. 
2. Запросы отправляются только для тех домов, у которых нет номера и тега `fixme`, так же пропускаются гаражи и сараи.

## Примечания

* После того как привели значение [адресных тегов](https://wiki.openstreetmap.org/wiki/RU:Key:addr) в порядок, не забудьте удалить тег `fixme`. 
* Плагин на данный момент загружает данные только для улиц, переулков и проездов. Проспекты, шоссе и т.п. не распознаются. 
* Для того чтоб принудительно загрузить и сохранить сырые данные, необходимо в настройках включить галочку "Записывать адрес из ЕГРН в `addr:RU:egrn`".
* Поиск дубликатов адресов производится во всех загруженных данных, независимо от расстояния. 

## TODO

- [x] Новый инструмент - пипетка. Создаёт точку с данными из ЕГРН в месте клика.
- [x] Локализация на русский. 
- [x] Отдельная галка в настройках для работы с дублями. Проверка существующих адресов и назначение адреса на самое большое по площади здание.
- [ ] Поддержка других типов улиц, такие как переулки, проспекты, шоссе и т.п.
- [ ] Возможность добавлять свои типы улиц в настройках.
- [ ] Возможность редактировать и добавлять пользовательские регулярные выражения для парсера адресов ЕГРН.
- [ ] Загрузка справочников типов улиц и регулярных выражений парсера через единый репозиторий. Избавит от необходимости обновления плагина и даст возможность другим людям дополнять парсер.
- [ ] Отдельный парсер для номеров домов. Должен приводить к [общепринятому виду](https://wiki.openstreetmap.org/wiki/RU:Addresses#%D0%9D%D1%83%D0%BC%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D1%8F_%D0%B4%D0%BE%D0%BC%D0%BE%D0%B2).
- [ ] Попытка повторной отправки ошибочных запросов установленное в настройках количество раз. Вывод уведомления о не загруженных данных.  
